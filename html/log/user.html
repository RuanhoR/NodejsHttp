<!doctype html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>用户 - 首页</title><style>:root{--primary:#4CAF50;--accent:#CD7655;--bg:#f9f9f9;--text:#333;--muted:#666;--danger:#f44336;--card-shadow:0 2px 8px rgba(0,0,0,0.08)}*{box-sizing:border-box;margin:0;padding:5px}body{background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;padding:12px}.header{display:flex;align-items:center;justify-content:space-between;background:var(--accent);color:#fff;padding:14px;border-radius:10px;margin-bottom:12px}#content{flex:1;overflow:auto}.card{background:#fff;border-radius:10px;padding:14px;margin-bottom:12px;box-shadow:var(--card-shadow)}.card .title{font-weight:600;margin-bottom:10px;border-bottom:1px solid #eee;padding-bottom:8px}.row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f3f3f3}.row:last-child{border-bottom:none}.label{flex:1;color:var(--muted)}.value{max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#555;margin:0 8px;text-align:right}.btn{border:0;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600}.btn-primary{background:var(--primary);color:#fff}.btn-danger{background:var(--danger);color:#fff}.small{font-size:13px;padding:6px 8px;border-radius:6px}input,select,textarea{padding:8px;border:1px solid #e6e6e6;border-radius:6px;width:100%;font-size:14px}.muted{color:var(--muted);font-size:13px}.error{color:var(--danger);font-size:13px;margin-top:6px}.success{color:var(--primary);font-size:13px;margin-top:6px}.bottom{position:sticky;bottom:0;display:flex;gap:8px;background:#585B5E;border-radius:10px;padding:8px;margin-top:10px}.tab{flex:1;text-align:center;color:#fff;padding:10px;border-radius:8px;cursor:pointer}.tab.active{background:var(--primary)}.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(0,0,0,0.75);color:#fff;padding:10px 14px;border-radius:8px;z-index:9999;display:none;pointer-events:none;font-size:14px}.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.35);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;margin-right:6px;vertical-align:middle}@keyframes spin{to{transform:rotate(360deg)}}@media (max-width:520px){.value{max-width:120px}}</style></head><body><div class="header"><div style="font-weight:700">首页</div><div id="user-name-display" class="muted"></div></div><div id="content"></div><div class="bottom"><div id="tab-settings" class="tab active">设置</div><div id="tab-discovery" class="tab">发现</div></div><div id="toast" class="toast"></div><script>
let currentUser = null;
const contentEl = document.getElementById('content');
const userNameDisplay = document.getElementById('user-name-display');
const toastEl = document.getElementById('toast');
function escapeHtml(unsafe) {
if (unsafe === null || unsafe === undefined) return '';
return String(unsafe)
.replace(/&/g, '&amp;')
.replace(/</g, '&lt;')
.replace(/>/g, '&gt;')
.replace(/"/g, '&quot;')
.replace(/'/g, '&#039;');
}
function showMessage(msg, timeout = 2000) {
if (!toastEl) return;
toastEl.textContent = msg;
toastEl.style.display = 'block';
clearTimeout(toastEl._t);
toastEl._t = setTimeout(()=> {
toastEl.style.display = 'none';
}, timeout);
}
async function POST(url, body = {}) {
try {
const res = await fetch(url, {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
credentials: 'include',
body: JSON.stringify(body)
});const text = await res.text();try {const json = JSON.parse(text);return json;} catch (e) {
return {
code: res.ok ? 200: -1,
msg: text || (res.ok ? 'OK': '服务器返回不可解析响应')
};
}
} catch (e) {
return {
code: -1,
msg: '网络错误，请检查连接'
};
}
}
function formatTime(ts) {
if (!ts) return '未知';
const n = Number(ts);
if (Number.isNaN(n)) return String(ts);
const d = new Date(n);
return d.toLocaleString();
}
function renderSettings() {
const u = currentUser || {};
userNameDisplay.textContent = u.name || '用户';
contentEl.innerHTML = `<div class="card"><div class="title">账户信息</div><div class="row"><div class="label">用户名</div><div class="value" title="${escapeHtml(u.name || '未设置')}">${escapeHtml(u.name || '未设置')}</div><div style="margin-left:8px"><button class="btn btn-primary" id="btn-edit-name">修改</button></div></div><div class="row"><div class="label">邮箱</div><div class="value" title="${escapeHtml(u.mail || '未设置')}">${escapeHtml(u.mail || '未设置')}</div><div style="margin-left:8px"><button class="btn btn-primary" id="btn-edit-mail">修改</button></div></div><div class="row"><div class="label">注册时间</div><div class="value" style="text-align:right">${u.Ctime ? formatTime(u.Ctime): '未知'}</div></div></div><div class="card"><div class="title">账户操作</div><button class="btn btn-danger" id="btn-logout">退出登录</button><button class="btn btn-danger" id="btn-delete">注销账户</button></div><div id="edit-area"></div>
`;
document.getElementById('btn-edit-name').addEventListener('click', showEditName);
document.getElementById('btn-edit-mail').addEventListener('click', showEditMail);
document.getElementById('btn-logout').addEventListener('click', showLogoutConfirm);
document.getElementById('btn-delete').addEventListener('click', showDeleteConfirm);
}
function showEditName() {
const ea = document.getElementById('edit-area');
ea.innerHTML = `<div class="card"><div class="title">修改用户名</div><div style="margin-bottom:8px"><input id="input-new-name" placeholder="输入新用户名" value="${escapeHtml(currentUser?.name || '')}"/><div id="error-name" class="error" style="display:none"></div></div>
<div style="display:flex;gap:8px">
<button id="save-name" class="btn btn-primary">确认修改</button>
<button id="cancel-name" class="btn small">取消</button></div></div>`;
document.getElementById('cancel-name').addEventListener('click', ()=> {
ea.innerHTML = '';
});
document.getElementById('save-name').addEventListener('click', submitNewUsername);
}

async function submitNewUsername() {
const el = document.getElementById('input-new-name');
const errEl = document.getElementById('error-name');
const newName = el.value.trim();
errEl.style.display = 'none';
if (!newName) {errEl.textContent = '用户名不能为空'; errEl.style.display = 'block'; return;}
const usernameRegex = /^[\u4e00-\u9fa5A-Za-z0-9_\-]{2,50}$/;
if (!usernameRegex.test(newName)) {
errEl.textContent = '用户名格式不正确(2-50位，可包含中文、字母、数字、下划线和连字符)';
errEl.style.display = 'block';
return;
}
const btn = document.getElementById('save-name');
btn.disabled = true;
const oldText = btn.textContent;
btn.innerHTML = '<span class="spinner"></span>保存中';
const result = await POST('/login/set', {setting: 'name', value: newName});
btn.disabled = false; btn.textContent = oldText;
if (result && result.code === 200) {
showMessage('用户名修改成功');
await loadUser();
renderSettings();
document.getElementById('edit-area').innerHTML = '';
} else {
errEl.textContent = result?.msg || '修改失败，请重试';
errEl.style.display = 'block';
}
}
function showEditMail() {
const ea = document.getElementById('edit-area');
ea.innerHTML = `
<div class="card">
<div class="title">修改邮箱</div>
<div style="margin-bottom:8px">
<input id="input-new-email" placeholder="输入新邮箱地址" value="${escapeHtml(currentUser?.mail || '')}" />
</div>
<div style="display:flex;gap:8px;margin-bottom:8px">
<input id="input-verify" placeholder="输入验证码" style="flex:1"/>
<button id="btn-send-verify" class="btn btn-primary small">发送验证码</button>
</div>
<div id="email-error" class="error" style="display:none"></div>
<div style="display:flex;gap:8px">
<button id="save-mail" class="btn btn-primary">确认修改</button>
<button id="cancel-mail" class="btn small">取消</button>
</div>
</div>
`;
document.getElementById('cancel-mail').addEventListener('click', ()=> {
ea.innerHTML = '';
});
document.getElementById('save-mail').addEventListener('click', submitNewEmail);
document.getElementById('btn-send-verify').addEventListener('click', sendVerifyCode);
}
async function sendVerifyCode() {
const mail = document.getElementById('input-new-email').value.trim();
const btn = document.getElementById('btn-send-verify');
const err = document.getElementById('email-error');
err.style.display = 'none';

if (!mail) {
err.textContent = '邮箱不能为空'; err.style.display = 'block'; return;
}
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
if (!emailRegex.test(mail)) {
err.textContent = '邮箱格式不正确'; err.style.display = 'block'; return;
}

btn.disabled = true;
const res = await POST('/login/verify', {
to: mail
});
if (res && res.code === 200) {
showMessage('验证码已发送');
let sec = 60;
btn.textContent = `已发送(${sec}s)`;
const timer = setInterval(()=> {
sec--;
if (sec <= 0) {
clearInterval(timer); btn.disabled = false; btn.textContent = '发送验证码';
} else btn.textContent = `已发送(${sec}s)`;
},
1000);
} else {
btn.disabled = false;
err.textContent = res?.msg || '发送失败，请重试';
err.style.display = 'block';
}
}


async function submitNewEmail() {
const mail = document.getElementById('input-new-email').value.trim();
const verify = document.getElementById('input-verify').value.trim();
const err = document.getElementById('email-error');
err.style.display = 'none';

if (!mail) {
err.textContent = '邮箱不能为空'; err.style.display = 'block'; return;
}
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
if (!emailRegex.test(mail)) {
err.textContent = '邮箱格式不正确'; err.style.display = 'block'; return;
}
if (!verify) {
err.textContent = '请填写验证码'; err.style.display = 'block'; return;
}

const btn = document.getElementById('save-mail');
btn.disabled = true;
const oldText = btn.textContent;
btn.innerHTML = '<span class="spinner"></span>保存中';

const res = await POST('/login/set', {
setting: 'mail', mail: mail, verify: verify
});
btn.disabled = false; btn.textContent = oldText;

if (res && res.code === 200) {
showMessage('邮箱修改成功');
await loadUser(); renderSettings();
document.getElementById('edit-area').innerHTML = '';
} else {
err.textContent = res?.msg || '修改失败，请重试';
err.style.display = 'block';
}
}


function showLogoutConfirm() {
const ea = document.getElementById('edit-area');
ea.innerHTML = `
<div class="card">
<div class="title">确认退出登录？</div>
<div class="muted" style="margin-bottom:12px">退出后需要重新登录才能访问您的账户</div>
<div style="display:flex;gap:8px">
<button id="confirm-logout" class="btn btn-danger">确认退出</button>
<button id="cancel-logout" class="btn small">取消</button>
</div>
</div>
`;
document.getElementById('cancel-logout').addEventListener('click', ()=> ea.innerHTML = '');
document.getElementById('confirm-logout').addEventListener('click', submitLogout);
}

async function submitLogout() {
const btn = document.getElementById('confirm-logout');
btn.disabled = true;
btn.innerHTML = '<span class="spinner"></span>退出中';
const res = await POST('/login/set', {
setting: 'clear', value: null
});
btn.disabled = false;
btn.innerHTML = '确认退出';
if (res && res.code === 200) {
showMessage('退出成功，跳转中...');

setTimeout(()=> {
window.location.href = '/log?source=p?page=user';
}, 800);
} else {
showMessage(res?.msg || '退出失败');
}
}


function showDeleteConfirm() {
const ea = document.getElementById('edit-area');
ea.innerHTML = `
<div class="card">
<div class="title">确认注销账户</div>
<div style="color:var(--danger);margin-bottom:10px">警告：此操作不可逆，您的数据将被删除！</div>
<div style="margin-bottom:8px">
<input id="input-del-password" type="password" placeholder="输入密码以确认"/>
<div id="error-del" class="error" style="display:none"></div>
</div>
<div style="display:flex;gap:8px">
<button id="confirm-del" class="btn btn-danger">确认注销</button>
<button id="cancel-del" class="btn small">取消</button>
</div>
</div>
`;
document.getElementById('cancel-del').addEventListener('click', ()=> {
ea.innerHTML = '';
});
document.getElementById('confirm-del').addEventListener('click', submitDelAccount);
}
async function submitDelAccount() {
const pass = document.getElementById('input-del-password').value.trim();
const err = document.getElementById('error-del');
err.style.display = 'none';
if (!pass) {
err.textContent = '密码不能为空'; err.style.display = 'block'; return;
}
const btn = document.getElementById('confirm-del');
btn.disabled = true;
const oldText = btn.textContent;
btn.innerHTML = '<span class="spinner"></span>注销中';
const res = await POST('/login/', {
type: 'del', name: currentUser?.name, password: pass
});
btn.disabled = false; btn.textContent = oldText;
if (res && res.code === 200) {
showMessage('账户注销成功，跳转登录页...');
setTimeout(()=> {
window.location.href = '/log?source=p?page=user';
}, 900);
} else {
err.textContent = res?.msg || '注销失败，请检查密码';
err.style.display = 'block';
}
}
function PageOn(u) {
location = u
}
function renderDiscovery() {return `<div class="card"><div class="title">发现</div><div style="margin-top:12px;display:flex;flex-direction:column;gap:8px"><button class="btn btn-primary" onclick="PageOn('/p?page=send')">发布Blog</button><button class="btn btn-primary" onclick="PageOn('/p?page=m')">聊天室</button><button class="btn btn-primary">敬请期待</button></div></div>`;}
async function loadUser() {const res = await POST('/login/get', {});
if (res && typeof res === 'object' && res.name !== undefined) {
currentUser = res;
} else if (res && res.code === 200 && res.data) {
currentUser = res.data;
} else {
currentUser = res;
}
}

async function init() {

document.getElementById('tab-settings').addEventListener('click', ()=> {
document.getElementById('tab-settings').classList.add('active');
document.getElementById('tab-discovery').classList.remove('active');
renderSettings();
});
document.getElementById('tab-discovery').addEventListener('click', ()=> {
document.getElementById('tab-discovery').classList.add('active');
document.getElementById('tab-settings').classList.remove('active');
contentEl.innerHTML = renderDiscovery();
});
try {
await loadUser();
renderSettings();} catch (e) {
contentEl.innerHTML = `<div class="card"><div class="title">加载失败</div><div class="muted">无法获取用户信息，请刷新或稍后重试。</div></div>`;
console.error(e);}}init();</script></body></html>